 : API de Upload Segura e Escal√°vel

## Contexto
Evoluir o backend do servi√ßo de upload desenvolvido em Go, transformando-o em uma API profissional, segura e preparada para monetiza√ß√£o, com prote√ß√£o robusta contra amea√ßas cibern√©ticas.

---

## üìã PARTE 1: Sistema de Usu√°rios e Autentica√ß√£o

### 1.1 Registro de Usu√°rios Aprimorado
**Campos obrigat√≥rios:**
- **Nome** (organizacional ou individual) - string, 3-100 caracteres
- **Email** - valida√ß√£o RFC 5322, √∫nico no sistema
- **WhatsApp** - formato internacional (+c√≥digo pa√≠s + n√∫mero), validado
- **Senha** - m√≠nimo 8 caracteres, com regras de complexidade:
  - Pelo menos 1 letra mai√∫scula
  - Pelo menos 1 letra min√∫scula
  - Pelo menos 1 n√∫mero
  - Pelo menos 1 caractere especial
  - Hash bcrypt com custo 12

**Valida√ß√µes de seguran√ßa no registro:**
```
‚úì Sanitiza√ß√£o de todos os inputs (prevenir XSS)
‚úì Valida√ß√£o de email com verifica√ß√£o de dom√≠nio real
‚úì Rate limit: m√°ximo 5 tentativas de registro por IP/hora  
‚úì Lista negra de emails descart√°veis (temp-mail, guerrillamail, etc)
‚úì Verifica√ß√£o de for√ßa de senha em tempo real 
```

### 1.2 Login e Gest√£o de Sess√µes
**Fluxo de autentica√ß√£o:**
- Login com **email + senha**
- Retorna **JWT** (24h validade) + **Refresh Token** (7 dias)
- Cada usu√°rio possui **FORGE_API_KEY** √∫nica e permanente
- Suporte a autentica√ß√£o via JWT ou API Key

**Medidas de seguran√ßa:**
```
‚úì Rate limit: 5 tentativas de login por email/15min
‚úì Bloqueio tempor√°rio ap√≥s 10 falhas (30 minutos)
‚úì Bloqueio permanente ap√≥s 20 falhas (requer recupera√ß√£o manual)
‚úì Logging de tentativas de login suspeitas
‚úì Alertas autom√°ticos de login em novo dispositivo/localiza√ß√£o 
‚úì Invalida√ß√£o de tokens comprometidos (blacklist de JWTs)
‚úì Rota√ß√£o autom√°tica de Refresh Tokens
```

---

## üîí PARTE 2: Prote√ß√£o Contra Ataques Cibern√©ticos

### 2.1 Prote√ß√£o SQL Injection
```
‚úì GORM com prepared statements (j√° implementado)
‚úì Valida√ß√£o estrita de UUIDs antes de queries
‚úì Sanitiza√ß√£o de todos os par√¢metros de busca
‚úì Desabilitar raw queries exceto em casos auditados
‚úì Logging de queries suspeitas (UNION, DROP, --, etc)
‚úì Whitelist de caracteres permitidos em nomes de projetos
‚úì Escape de caracteres especiais em paths
```

### 2.2 Prote√ß√£o XSS e File Upload Attacks
```
‚úì Valida√ß√£o de MIME type real (magic bytes), n√£o apenas headers
‚úì Renomear todos os arquivos com UUID + timestamp
‚úì Remover metadados EXIF de imagens (prevenir vazamento de dados)
‚úì Scan antiv√≠rus em uploads (ClamAV ou similar)
‚úì Whitelist de extens√µes: .jpg, .jpeg, .png, .pdf, .gif, .webp
‚úì Blacklist expl√≠cita: .exe, .sh, .bat, .html, .js, .php
‚úì Content-Security-Policy headers nos responses
‚úì Sanitiza√ß√£o de nomes de arquivos (remover ../, /, \, etc)
‚úì Armazenamento fora do webroot
‚úì Servir arquivos com X-Content-Type-Options: nosniff
```

### 2.3 Rate Limiting Avan√ßado
```
‚úì Por IP: 100 requests/minuto (geral)
‚úì Por usu√°rio: 1000 requests/hora (autenticado)
‚úì Uploads: 50/dia no plano gratuito, 500/dia no premium
‚úì Tamanho de arquivo: 10MB/upload (gratuito), 100MB (premium)
‚úì Bandwidth total: 5GB/m√™s (gratuito), 100GB (premium)
‚úì Implementar com redis ou in-memory cache
‚úì Headers de resposta: X-RateLimit-Limit, X-RateLimit-Remaining
‚úì Resposta 429 Too Many Requests com Retry-After header
```

### 2.4 Prote√ß√£o DDoS e Brute Force
```
‚úì Implementar slowloris protection
‚úì Request timeout: 30 segundos
‚úì Limitar tamanho do body: 10MB
‚úì Validar Content-Length antes de processar
‚úì Implementar exponential backoff em falhas 
‚úì Monitoramento de anomalias (picos s√∫bitos de tr√°fego)
```

### 2.5 Auditoria e Monitoramento
```
‚úì Log estruturado (JSON) com:
  - user_id, action, ip_address, user_agent
  - timestamp, endpoint, method, status_code
  - response_time, error_details
‚úì Detec√ß√£o de comportamento suspeito:
  - M√∫ltiplos uploads de arquivos id√™nticos
  - Tentativas de acesso a recursos de outros usu√°rios
  - Varia√ß√£o anormal de tamanho de uploads
  - Requests de IPs de pa√≠ses bloqueados
‚úì Alertas autom√°ticos via webhook/email
‚úì Reten√ß√£o de logs: 90 dias (gratuito), 1 ano (premium)
‚úì Integra√ß√£o com SIEM (opcional)
```

---

## üíæ PARTE 3: Sistema de Quotas e Planos

### 3.1 Modelo de Dados - Planos
```go
type Plan struct {
    ID                uuid.UUID `gorm:"type:uuid;primary_key"`
    Name              string    `gorm:"not null"` // "free", "basic", "pro", "enterprise"
    StorageQuotaBytes int64     `gorm:"not null"` // 1GB, 10GB, 100GB, ilimitado
    MaxFileSize       int64     `gorm:"not null"` // 10MB, 100MB, 1GB
    MaxUploadsPerDay  int       `gorm:"not null"` // 50, 500, 5000, ilimitado
    MaxProjects       int       `gorm:"not null"` // 5, 50, 500, ilimitado
    PriceMonthly      float64   `gorm:"not null"` // 0, 9.99, 49.99, 299.99
    Features          JSONB     `gorm:"type:jsonb"` // features adicionais
    CreatedAt         time.Time
    UpdatedAt         time.Time
}
```

### 3.2 Modelo de Dados - Assinatura do Usu√°rio
```go
type UserSubscription struct {
    ID                uuid.UUID `gorm:"type:uuid;primary_key"`
    UserID            uuid.UUID `gorm:"type:uuid;not null;uniqueIndex"`
    PlanID            uuid.UUID `gorm:"type:uuid;not null"`
    StorageUsedBytes  int64     `gorm:"default:0;not null"`
    UploadsToday      int       `gorm:"default:0;not null"`
    LastUploadDate    time.Time
    SubscriptionStart time.Time `gorm:"not null"`
    SubscriptionEnd   time.Time // null = plano gratuito
    Status            string    `gorm:"not null"` // "active", "suspended", "cancelled"
    PaymentMethod     string    // para integra√ß√£o futura
    CreatedAt         time.Time
    UpdatedAt         time.Time
}
```

### 3.3 Modelo de Dados - Hist√≥rico de Uso
```go
type UsageLog struct {
    ID             uuid.UUID `gorm:"type:uuid;primary_key"`
    UserID         uuid.UUID `gorm:"type:uuid;not null;index"`
    Action         string    `gorm:"not null"` // "upload", "delete", "download"
    ProjectName    string
    FileName       string
    FileSize       int64
    StorageDelta   int64     // +bytes (upload) ou -bytes (delete)
    IPAddress      string
    UserAgent      string
    Timestamp      time.Time `gorm:"not null;index"`
}
```

### 3.4 Atualiza√ß√£o do Modelo User
```go
type User struct {
    ID                uuid.UUID         `gorm:"type:uuid;primary_key"`
    Name              string            `gorm:"not null"` // NOVO
    Email             string            `gorm:"uniqueIndex;not null"`
    WhatsApp          string            `gorm:"not null"` // NOVO
    Password          string            `gorm:"not null"`
    ForgeAPIKey       string            `gorm:"uniqueIndex;not null"`
    EmailVerified     bool              `gorm:"default:false"` // NOVO
    EmailVerifyToken  string            `gorm:"index"` // NOVO
    TwoFactorEnabled  bool              `gorm:"default:false"` // NOVO
    TwoFactorSecret   string            // NOVO
    AccountStatus     string            `gorm:"default:'active'"` // active/suspended/banned
    LastLoginAt       time.Time         // NOVO
    LastLoginIP       string            // NOVO
    FailedLoginCount  int               `gorm:"default:0"` // NOVO
    LockedUntil       *time.Time        // NOVO
    CreatedAt         time.Time
    UpdatedAt         time.Time
    Projects          []Project         `gorm:"foreignKey:UserID"`
    Subscription      UserSubscription  `gorm:"foreignKey:UserID"` // NOVO
}
```

### 3.5 Implementa√ß√£o de Checagem de Quota
```
Antes de cada upload:
‚úì Verificar se storage_used + file_size <= storage_quota
‚úì Verificar se uploads_today < max_uploads_per_day
‚úì Verificar se file_size <= max_file_size do plano
‚úì Verificar se n√∫mero de projetos <= max_projects
‚úì Retornar erro 402 Payment Required se excedido
‚úì Sugerir upgrade de plano na resposta
```

**Plano Gratuito Padr√£o:**
```
- Storage: 1GB
- Max file size: 10MB
- Uploads/dia: 50
- Projetos: 5
- Bandwidth: 5GB/m√™s
```

---

## üõ°Ô∏è PARTE 4: Endpoint de Seguran√ßa Adicional

### 4.1 Novos Endpoints
```
POST   /api/user/verify-email         - Confirmar email com token
POST   /api/user/resend-verification  - Reenviar email de confirma√ß√£o
POST   /api/user/enable-2fa           - Ativar autentica√ß√£o 2FA
POST   /api/user/verify-2fa           - Validar c√≥digo 2FA no login
GET    /api/user/usage                - Ver uso atual de storage/quotas
GET    /api/user/activity-log         - Ver hist√≥rico de atividades
POST   /api/user/rotate-api-key       - Rotacionar FORGE_API_KEY (j√° existe)
POST   /api/user/change-password      - Trocar senha (com senha antiga)
POST   /api/user/reset-password       - Solicitar reset de senha
GET    /api/plans                     - Listar planos dispon√≠veis
POST   /api/subscription/upgrade      - Upgrade de plano (futuro)
```

### 4.2 Headers de Seguran√ßa Obrigat√≥rios
```go
w.Header().Set("X-Content-Type-Options", "nosniff")
w.Header().Set("X-Frame-Options", "DENY")
w.Header().Set("X-XSS-Protection", "1; mode=block")
w.Header().Set("Strict-Transport-Security", "max-age=31536000")
w.Header().Set("Content-Security-Policy", "default-src 'self'")
w.Header().Set("Referrer-Policy", "strict-origin-when-cross-origin")
w.Header().Set("Permissions-Policy", "geolocation=(), microphone=(), camera=()")
```

---

## üéØ PARTE 5: Checklist de Implementa√ß√£o

### Fase 1: Seguran√ßa B√°sica (Prioridade ALTA)
```
[ ] Valida√ß√£o de inputs com whitelist
[ ] Prote√ß√£o SQL injection (verificar GORM)
[ ] Valida√ß√£o de MIME type real
[ ] Rate limiting b√°sico (100 req/min)
[ ] Headers de seguran√ßa
[ ] Logging estruturado
[ ] Sanitiza√ß√£o de nomes de arquivos
```

### Fase 2: Sistema de Usu√°rios (Prioridade ALTA)
```
[ ] Atualizar modelo User (nome, whatsapp, etc)
[ ] Criar tabela Plans
[ ] Criar tabela UserSubscription
[ ] Criar tabela UsageLog
[ ] Implementar registro com novos campos
[ ] Implementar verifica√ß√£o de email
[ ] Atualizar login (manter email+senha)
```

### Fase 3: Sistema de Quotas (Prioridade ALTA)
```
[ ] Middleware de checagem de quota antes de uploads
[ ] Contador de storage usado por usu√°rio
[ ] Limite de 1GB para plano gratuito
[ ] Contador de uploads di√°rios
[ ] Endpoint GET /api/user/usage
[ ] Erro 402 com sugest√£o de upgrade
```

### Fase 4: Seguran√ßa Avan√ßada (Prioridade M√âDIA)
```
[ ] Implementar 2FA/TOTP
[ ] Scan antiv√≠rus em uploads (ClamAV)
[ ] Detec√ß√£o de comportamento suspeito
[ ] Sistema de alertas autom√°ticos
[ ] Bloqueio autom√°tico por tentativas
[ ] Whitelist/blacklist de IPs
```

### Fase 5: Monetiza√ß√£o (Prioridade BAIXA - Prepara√ß√£o)
```
[ ] Endpoint GET /api/plans
[ ] Endpoint POST /api/subscription/upgrade (mock)
[ ] Estrutura para webhook de pagamento
[ ] Dashboard de administra√ß√£o
[ ] Sistema de cupons/descontos
```

---

## üìä Exemplo de Resposta de Quota Excedida

```json
{
  "error": "Storage quota exceeded",
  "message": "You've used 1.02GB of your 1GB limit",
  "current_usage": {
    "storage_used": "1.02GB",
    "storage_limit": "1GB",
    "uploads_today": 48,
    "uploads_limit": 50
  },
  "suggested_action": {
    "upgrade_to": "Basic Plan",
    "new_limit": "10GB",
    "price": "$9.99/month",
    "url": "https://uploader.../plans"
  }
}
```

---

## üö® Alertas de Seguran√ßa Cr√≠ticos

O sistema deve alertar automaticamente quando detectar:
```
‚ö†Ô∏è Mais de 10 tentativas de login falhadas em 1 hora
‚ö†Ô∏è Upload de arquivo com malware detectado
‚ö†Ô∏è Tentativa de acesso a recursos de outro usu√°rio
‚ö†Ô∏è Padr√£o de scraping (muitos GETs sequenciais)
‚ö†Ô∏è Upload de arquivo com MIME type falsificado
‚ö†Ô∏è Spike de tr√°fego (>1000 req/min de um IP)
‚ö†Ô∏è SQL injection pattern detectado
‚ö†Ô∏è Path traversal attempt (../, etc)
```

---

## ‚úÖ Resultado Final Esperado

Uma API de upload:
- ‚úÖ **Segura** contra SQL injection, XSS, DDoS, brute force
- ‚úÖ **Profissional** com quotas, planos e auditoria
- ‚úÖ **Escal√°vel** preparada para crescimento e monetiza√ß√£o
- ‚úÖ **Simples** de usar para desenvolvedores
- ‚úÖ **Monitorada** com logs e alertas autom√°ticos
- ‚úÖ **Preparada** para integra√ß√£o com gateways de pagamento

 